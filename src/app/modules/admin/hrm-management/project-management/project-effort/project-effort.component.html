<div class="flex flex-col h-full">
  <!--        header-->
  <div class="header border-b flex justify-between items-center pb-3">
    <div class="text-2xl font-bold card-title capitalize">
      {{ "effort.title" | transloco }}
    </div>
    <div>
      <button mat-icon-button class="hover:bg-slate-200" (click)="dialogRef.close()">
        <mat-icon class="icon-size-5" svgIcon="heroicons_outline:x" title="Close"></mat-icon>
      </button>
    </div>
  </div>
  <div class="w-full pl-2 pr-2 content overflow-auto">
    <!-- Form -->
    <form [formGroup]="formGroup">
      <!-- Section -->
      <div class="grid sm:grid-cols-4 gap-4 w-full mt-8">
        <div class="sm:col-span-4 grid grid-cols-4 gap-6 w-full">
          <!-- tHÁNG -->
          <div class="sm:col-span-2">
            <mat-form-field class="fuse-mat-no-subscript w-full">
              <mat-label>{{ "effort.spring" | transloco }}</mat-label>
              <input matInput [matDatepicker]="startDate" datePickerFormat="MM/YYYY" [formControlName]="'startDate'"
                (ngModelChange)="changeMonth()" [placeholder]="'placeholder.chooseDate' | transloco" />
              <mat-datepicker-toggle [for]="startDate"> </mat-datepicker-toggle>
              <mat-datepicker startView="multi-year" (yearSelected)="
                  chosenYearHandler($event, formGroup.get('startDate'))
                " (monthSelected)="
                  chosenMonthHandler(
                    $event,
                    startDate,
                    formGroup.get('startDate')
                  )
                " #startDate></mat-datepicker>
            </mat-form-field>
            <app-error-message [control]="formGroup.get('startDate')"
              [name]="'effort.month' | transloco"></app-error-message>
          </div>
        </div>
      </div>
      <div class="grid sm:grid-cols-4 gap-4 w-full mt-8">
        <div class="sm:col-span-4 grid grid-cols-4 gap-6 w-full">
          <!-- ƯỚC LƯỢNG -->
          <div class="sm:col-span-1">
            <div class="mb-1">
              <label class="w-full font-medium required" for="estimate">{{ "effort.effort_estimate" | transloco }}
                (MM)</label>
            </div>
            <mat-form-field class="fuse-mat-no-subscript fuse-mat-emphasized-affix w-full">
              <input id="estimate" [formControlName]="'estimate'" type="text" matInput decimalNumber
                [placeholder]="('effort.effort_estimate' | transloco) + ' (MM)'" />
            </mat-form-field>
            <app-error-message [control]="formGroup.get('estimate')" [name]="'effort.effort_estimate' | transloco"
              [textPattern]="
                'common.message.number_format'
                  | transloco : { filed: 'effort.estimate' | transloco }
              ">
            </app-error-message>
          </div>
          <!-- ĐƠN GIÁ -->
          <div class="sm:col-span-1 bg-cus">
            <div class="mb-1">
              <label class="w-full font-medium" for="unitPrice">{{
                "hrm-management.project.form.price" | transloco
                }}
                (VND)</label>
            </div>
            <mat-form-field class="fuse-mat-no-subscript fuse-mat-emphasized-affix w-full" >
              <input id="unitPrice" [formControlName]="'unitPrice'" type="text" matInput readonly="true" vnd-currency
                [placeholder]="('hrm-management.project.form.price' | transloco) + ' (VND)'" />
            </mat-form-field>
          </div>
          <!-- % HOÀN THÀNH -->
          <div class="sm:col-span-1">
            <div class="mb-1">
              <label class="w-full font-medium" for="percent_effort">{{ "effort.percent_effort" | transloco }}</label>
            </div>
            <mat-form-field class="fuse-mat-no-subscript fuse-mat-emphasized-affix w-full">
              <input id="percent_effort" [formControlName]="'progress'" type="text" matInput onlyNumber
                [placeholder]="'effort.percent_effort' | transloco" [min]="1" [max]="100" minMax/>
            </mat-form-field>
            <app-error-message [control]="formGroup.get('percentCompelete')"
              [name]="'effort.percent_effort' | transloco">
            </app-error-message>
          </div>
          <!-- GHI NHẬN NỖ LỰC -->
          <div class="sm:col-span-1 bg-cus">
            <div class="mb-1">
              <label class="w-full font-medium" for="effort-spring">{{
                "effort.acknowledgmentOfEffort" | transloco
                }}
                (MM)</label>
            </div>
            <mat-form-field class="fuse-mat-no-subscript fuse-mat-emphasized-affix w-full">
              <input id="effort-spring" [formControlName]="'effort'" type="text" matInput readonly="true" onlyNumber
                [placeholder]="('effort.acknowledgmentOfEffort' | transloco)+' (MM)'" />
            </mat-form-field>
          </div>
        </div>
      </div>

      <div class="grid sm:grid-cols-4 gap-4 w-full mt-8">
        <div class="sm:col-span-4 grid grid-cols-4 gap-6 w-full">
          <!-- GHI NHẬN NỖ LỰC QUY ĐỔI (MM) -->
          <div class="sm:col-span-1 bg-cus">
            <div class="mb-1">
              <label class="w-full font-medium" for="effortExchange">{{
                "effort.acknowledgmentOfEffortChange" | transloco
                }}
                (MM)</label>
            </div>
            <mat-form-field class="fuse-mat-no-subscript fuse-mat-emphasized-affix w-full">
              <input id="effortExchange" type="text" [formControlName]="'effortExchange'" matInput readonly="true"
                onlyNumber [placeholder]="('effort.acknowledgmentOfEffortChange' | transloco)+' (MM)'" />
            </mat-form-field>
          </div>
          <!-- NGHIỆM THU -->
          <div class="sm:col-span-1">
            <div class="mb-1">
              <label class="w-full font-medium" for="acceptanceEffort">{{ "effort.effort_accept" | transloco }} (MM)</label>
            </div>
            <mat-form-field class="fuse-mat-no-subscript w-full">
              <input id="acceptanceEffort" [formControlName]="'acceptanceEffort'" type="text" matInput decimalNumber
                [placeholder]="'effort.effort_accept' | transloco" />
            </mat-form-field>
            <app-error-message [control]="formGroup.get('acceptanceEffort')"
              [name]="'effort.effort_accept' | transloco">
            </app-error-message>
          </div>
          <!-- NGÀY NGHIỆM THU -->
          <div class="sm:col-span-1">
            <div class="mb-1">
              <label class="w-full font-medium" for="acceptanceDate">{{ "effort.accept_date" | transloco
                }}</label>
            </div>
            <mat-form-field class="fuse-mat-no-subscript w-full">
              <input id="acceptanceDate" matInput type="text" [matDatepicker]="acceptanceDatePicker" datePickerFormat="DD/MM/YYYY"
                [formControlName]="'acceptanceDate'" [placeholder]="'effort.accept_date' | transloco" />
              <mat-datepicker-toggle [for]="acceptanceDatePicker"> </mat-datepicker-toggle>
              <mat-datepicker #acceptanceDatePicker></mat-datepicker>
            </mat-form-field>
            <!-- <app-error-message
              [control]="formGroup.get('acceptanceDate')"
              [name]="'common.message.date_format' | transloco"
            >
            </app-error-message> -->
          </div>
          <!-- UPLOAD FILE -->
          <div class="sm:col-span-1 uploadStyle">
            <div class="fuse-mat-no-subscript w-full">
              <input type="file" name="document" class="file-input" (change)="uploadFile($event)" #fileUpload />

              <div class="file-upload">
                <ng-container *ngIf="visibleBtnUpload">
                  <button mat-raised-button color="primary" class="upload-btn" (click)="fileUpload.click()">
                    <mat-icon svgIcon="heroicons_outline:paper-clip"></mat-icon>
                    {{ "effort.chooseFile" | transloco }}
                  </button>
                </ng-container>
                <div class="flex">
                  <ng-container *ngIf="documentName">
                    <div class="nameFile">
                      <a (click)="downloadDocument(recordUrl)" title="{{ documentName }}">
                        {{ documentName }}
                      </a>
                    </div>
                    <button class="icon-size-5" mat-icon-button color="primary" (click)="removeFile()">
                      <mat-icon svgIcon="heroicons_outline:x" title="Close"></mat-icon>
                    </button>
                  </ng-container>
                  <!-- <ng-container *ngIf="!documentName">
                    <p> No file uploaded yet. </p>
                  </ng-container> -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid sm:grid-cols-4 gap-4 w-full mt-8">
        <div class="sm:col-span-4 grid grid-cols-4 gap-6 w-full">
          <!-- CHÊNH LỆCH (MM)-->
          <div class="sm:col-span-1 bg-cus">
            <div class="mb-1">
              <label class="w-full font-medium" for="effortDifference">{{ "effort.difference_effort" | transloco }}
                (MM)</label>
            </div>
            <mat-form-field class="fuse-mat-no-subscript fuse-mat-emphasized-affix w-full">
              <input id="effortDifference" [formControlName]="'effortDifference'" type="text" readonly="true" matInput
                onlyNumber [placeholder]="('effort.difference_effort' | transloco)+' (MM)'" />
            </mat-form-field>
          </div>

          <!-- CHÊNH LỆCH LŨY KẾ (MM)-->
          <div class="sm:col-span-1 bg-cus">
            <div class="mb-1">
              <label class="w-full font-medium" for="cumulativeDifference">{{ "effort.cumulativeDifference" | transloco
                }}
                (MM)</label>
            </div>
            <mat-form-field class="fuse-mat-no-subscript w-full">
              <input id="cumulativeDifference" [formControlName]="'cumulativeDifference'" type="text" readonly="true"
                matInput vnd-currency [placeholder]="('effort.cumulativeDifference' | transloco)+' (MM)'" />
            </mat-form-field>
          </div>
          <!-- CHÊNH LỆCH (VND) -->
          <div class="sm:col-span-1 bg-cus">
            <div class="mb-1">
              <label class="w-full font-medium" for="effortDifferenceVnd">{{ "effort.difference_effort" | transloco }}
                (VND)</label>
            </div>
            <mat-form-field class="fuse-mat-no-subscript fuse-mat-emphasized-affix w-full">
              <input id="effortDifferenceVnd" [formControlName]="'effortDifferenceVnd'" type="text" readonly="true"
                matInput vnd-currency [placeholder]="('effort.difference_effort' | transloco)+' (VND)'" />
            </mat-form-field>
          </div>
          <!-- CHÊNH LỆCH LŨY KẾ (VND)-->
          <div class="sm:col-span-1 bg-cus">
            <div class="mb-1">
              <label class="w-full font-medium" for="cumulativeDifference">{{
                "effort.cumulativeDifference" | transloco
                }}
                (VND)</label>
            </div>
            <mat-form-field class="fuse-mat-no-subscript w-full">
              <input id="cumulativeDifference" [formControlName]="'cumulativeDifferenceVnd'" type="text" readonly="true"
                matInput onlyNumber [placeholder]="('effort.cumulativeDifference' | transloco)+' (VND)'" />
            </mat-form-field>
          </div>
        </div>
      </div>

      <div class="grid sm:grid-cols-4 gap-4 w-full mt-8 mb-8">
        <div class="sm:col-span-4 grid grid-cols-4 gap-6 w-full">
          <!-- PHÂN BỔ NỖ LỰC-->
          <div class="sm:col-span-4">
            <div class="header flex justify-between items-center pb-3">
              <div class="text-2xl font-bold card-title">
                {{ "effort.allocate_effort" | transloco }}
              </div>
              <button mat-raised-button color="primary" (click)="addNewRow()">
                <mat-icon class="icon-size-6" svgIcon="heroicons_outline:plus"></mat-icon>
                {{ "effort.add" | transloco }}
              </button>
            </div>
          </div>
          <!-- TABLE PHÂN BỔ NỖ LỰC-->
          <div class="sm:col-span-4">
            <app-data-table *ngIf="!isLoading" formArrayName="effortDetail" [roleName]="_permissionCodeName"
              [rows]="efforts.controls" [columns]="columns" [paginate]="false" [limit]="searchModel.pageSize"
              [count]="searchResult.totalRecords" (action)="actionClick($event)" (pageChange)="changePage($event)"
              [rowTemplate]="rowTemplate">
              <ng-template #rowTemplate let-row="row" let-column="column" let-index="index">
                <ng-container [ngSwitch]="column.columnDef" [formGroupName]="index">

                  <ng-container *ngSwitchCase="'staffName'">
                    <div class="field flex mt-2 mb-2">
                      <div class="input w-5/6">
                        <mat-form-field class="fuse-mat-no-subscript w-full mt-4 sm:mt-0 bg-card">
                          <mat-select placeholder="{{ 'staff.staffName' | transloco }}" formControlName="staffId"
                            (selectionChange)="onStaffChange($event, index)">
                            <mat-select-filter [placeholder]="'common.search' | transloco" [displayMember]="'fullName'"
                              [array]="listStaff[index]" (filteredReturn)="filteredList[index] = $event">
                            </mat-select-filter>
                            <mat-option *ngFor="let staffNameTxt of filteredList[index]" [value]="staffNameTxt.id">
                              {{ staffNameTxt?.fullName }}
                            </mat-option>
                          </mat-select>
                        </mat-form-field>
                        <app-error-message [control]="efforts.controls[index].get('staffId')"
                          [name]="'common.name' | transloco">
                        </app-error-message>
                        <div [hidden]="disabledLogErr" class="errors">
                          <span>{{
                            "effort.same_name_err" | transloco
                          }}</span>
                        </div>

                      </div>
                    </div>
                  </ng-container>

                  <ng-container *ngSwitchCase="'roleName'">
                    <div class="field flex mt-2 mb-2">
                      <div class="input w-5/6">
                        <mat-form-field class="fuse-mat-no-subscript w-full mt-4 sm:mt-0 bg-card">
                          <mat-select placeholder="{{ 'effort.role' | transloco }}" formControlName="roleId">
                            <mat-select-filter [placeholder]="'common.search' | transloco" [displayMember]="'name'"
                              [array]="listRole[index]" (filteredReturn)="filteredListRole[index] = $event">
                            </mat-select-filter>
                            <mat-option *ngFor="let rolName of filteredListRole[index]" [value]="rolName.id">
                              {{ rolName?.name }}
                            </mat-option>
                          </mat-select>
                        </mat-form-field>
                        <!-- <mat-form-field class="fuse-mat-no-subscript w-full mt-4 sm:mt-0 bg-card">
                          <mat-select placeholder="{{ 'effort.role' | transloco }}" formControlName="roleId">
                            <mat-option *ngFor="let item of listStaffLevels" [value]="item?.id">
                              {{ item?.name }}
                            </mat-option>
                          </mat-select>
                        </mat-form-field> -->
                        <app-error-message [control]="efforts.controls[index].get('roleId')"
                          [name]="'effort.role' | transloco">
                        </app-error-message>
                      </div>
                    </div>
                  </ng-container>

                  <ng-container *ngSwitchCase="'effort'">
                    <div class="field flex mt-2 mb-2">
                      <div class="input w-5/6">
                        <mat-form-field class="fuse-mat-no-subscript w-full mt-4 sm:mt-0 bg-card">
                          <input type="text" matInput decimalNumber (ngModelChange)="caculateExchange($event, index)"
                            formControlName="effort" placeholder="{{
                              'effort.acknowledgmentOfEffort' | transloco
                            }}" />
                        </mat-form-field>
                      </div>
                    </div>
                  </ng-container>

                  <ng-container *ngSwitchCase="'actionCustom'">
                    <div class="field flex mt-2 mb-2">
                      <div class="input w-6/6">
                        <button mat-icon-button
                          class="mat-focus-indicator mat-icon-button mat-button-base ng-star-inserted"
                          (click)="deleteRow(index)">
                          <mat-icon class="icon-size-5" svgIcon="heroicons_outline:trash" title="Close"></mat-icon>
                        </button>
                      </div>
                    </div>
                  </ng-container>
                  <ng-container *ngSwitchDefault>
                    <div [innerHTML]="
                        column.cellRenderer
                          ? column.cellRenderer(row.value)
                          : row.value[column.columnDef]
                      " class="whitespace-nowrap"></div>
                  </ng-container>
                </ng-container>
              </ng-template>
            </app-data-table>
          </div>

          <!-- DOANH THU-->
          <div class="sm:col-span-1 bg-cus">
            <div class="mb-1">
              <label class="w-full font-medium" for="turnover">{{ "effort.turnover" | transloco }}</label>
            </div>
            <mat-form-field class="fuse-mat-no-subscript w-full">
              <input id="turnover" [formControlName]="'revenue'" type="text" readonly="true" matInput vnd-currency
                [placeholder]="'effort.turnover' | transloco" />
            </mat-form-field>
          </div>
          <!-- CHI PHÍ-->
          <div class="sm:col-span-1 bg-cus">
            <div class="mb-1">
              <label class="w-full font-medium" for="cost">{{ "effort.cost" | transloco }}</label>
            </div>
            <mat-form-field class="fuse-mat-no-subscript w-full">
              <input id="cost" [formControlName]="'cost'" type="text" readonly="true" matInput vnd-currency
                [placeholder]="'effort.cost' | transloco" />
            </mat-form-field>
          </div>
          <!-- HIỆU SUẤT-->
          <div class="sm:col-span-1 bg-cus">
            <div class="mb-1">
              <label class="w-full font-medium" for="efficiency">{{ "effort.efficiency" | transloco }}</label>
            </div>
            <mat-form-field class="fuse-mat-no-subscript w-full">
              <input id="efficiency" [formControlName]="'efficiency'" type="text" matInput readonly="true" onlyNumber
                [placeholder]="'effort.efficiency' | transloco"  />
            </mat-form-field>
          </div>
          <!-- GHI CHÚ -->
          <div class="sm:col-span-4">
            <div class="mb-1">
              <label class="w-full font-medium">{{ "common.note" | transloco }}</label>
            </div>
            <mat-form-field class="fuse-mat-textarea fuse-mat-no-subscript w-full">
              <textarea matInput [formControlName]="'note'" cdkTextareaAutosize [cdkAutosizeMinRows]="5"></textarea>
            </mat-form-field>
          </div>
        </div>
      </div>
      <!-- Divider -->
      <!-- <div class="mt-11 mb-10 border-t"></div> -->
    </form>
  </div>
  <!-- Actions -->
  <div class="footer mt-6 flex justify-end">
    <button mat-raised-button class="mr-3" (click)="dialogRef.close()">
      <mat-icon class="icon-size-5 mr-2" svgIcon="heroicons_outline:x"></mat-icon>
      <span>{{ "button.cancel" | transloco }}</span>
    </button>
    <button mat-raised-button color="primary" (click)="save()" [disabled]="disBtn">
      <mat-icon class="icon-size-5 mr-2" svgIcon="heroicons_outline:check"></mat-icon>
      <span>{{ "button.save" | transloco }}</span>
    </button>
  </div>
</div>
